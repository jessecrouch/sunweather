<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake & Volcano Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a4a;
            height: 50px;
        }
        header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }
        header h1 span {
            color: #ff6b6b;
        }
        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-value {
            font-weight: 600;
            color: #fff;
        }
        .stat-label {
            color: #888;
        }
        
        /* Controls */
        .controls {
            background: #12121a;
            padding: 10px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid #2a2a3a;
            height: 46px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .control-group label {
            font-size: 0.75rem;
            color: #888;
        }
        .controls select, .controls button {
            background: #1a1a2a;
            color: #ddd;
            border: 1px solid #3a3a4a;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .controls select:hover, .controls button:hover {
            background: #2a2a3a;
            border-color: #4a4a5a;
        }
        .controls button.active {
            background: #3a5a8a;
            border-color: #4a7aba;
        }
        .refresh-btn {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .refresh-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .last-updated {
            font-size: 0.7rem;
            color: #555;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 96px);
        }
        
        /* Map */
        #map {
            flex: 1;
            background: #0a0a0f;
        }
        .leaflet-container {
            background: #0a0a0f;
        }
        
        /* Sidebar */
        .sidebar {
            width: 360px;
            background: #0d0d14;
            border-left: 1px solid #2a2a3a;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 12px 14px;
            background: #1a1a2a;
            border-bottom: 1px solid #2a2a3a;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .quake-list {
            flex: 1;
            overflow-y: auto;
        }
        .quake-item {
            padding: 12px 14px;
            border-bottom: 1px solid #1a1a2a;
            cursor: pointer;
            transition: background 0.15s;
        }
        .quake-item:hover {
            background: #15151f;
        }
        .quake-item.selected {
            background: #1a2a3a;
            border-left: 3px solid #4a8afa;
        }
        .quake-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        .quake-mag {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1;
            min-width: 50px;
        }
        .quake-location {
            flex: 1;
            font-size: 0.8rem;
            color: #ccc;
            margin-left: 10px;
            line-height: 1.3;
        }
        .quake-details {
            display: flex;
            gap: 12px;
            font-size: 0.7rem;
            color: #666;
            margin-top: 6px;
            margin-left: 60px;
        }
        .quake-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Toggle Styles */
        .toggle-group {
            display: flex;
            gap: 14px;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #ccc;
        }
        .toggle-label input {
            display: none;
        }
        .toggle-indicator {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            border: 2px solid #555;
            transition: all 0.15s;
        }
        .toggle-label input:checked + .toggle-indicator {
            border-color: transparent;
        }
        .quake-toggle {
            border-radius: 50%;
        }
        .toggle-label input:checked + .quake-toggle {
            background: #eb2;
            box-shadow: 0 0 6px #eb2;
        }
        .volcano-toggle {
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 12px solid #555;
            border-radius: 0;
            background: transparent !important;
        }
        .toggle-label input:checked + .volcano-toggle {
            border-bottom-color: #f55;
            box-shadow: 0 2px 6px #f55;
        }
        
        /* Magnitude Colors */
        .mag-0 { color: #4a9; }
        .mag-1 { color: #4a9; }
        .mag-2 { color: #6b4; }
        .mag-3 { color: #8c4; }
        .mag-4 { color: #bc3; }
        .mag-5 { color: #eb2; }
        .mag-6 { color: #f82; }
        .mag-7 { color: #f52; }
        .mag-8 { color: #f28; }
        .mag-9 { color: #f2f; }
        
        /* Volcano Alert Colors */
        .alert-warning { color: #f93; }
        .alert-watch { color: #eb2; }
        .alert-advisory { color: #9b5; }
        .alert-normal { color: #6a9; }
        .alert-unassigned { color: #888; }
        
        /* Volcano item styles */
        .volcano-item {
            border-left: 3px solid transparent;
        }
        .volcano-item .item-icon {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 16px solid #f55;
            margin-right: 10px;
        }
        .volcano-item.alert-warning { border-left-color: #f55; }
        .volcano-item.alert-watch { border-left-color: #f93; }
        .volcano-item.alert-advisory { border-left-color: #eb2; }
        .volcano-item.alert-normal { border-left-color: #6a9; }
        
        /* Volcano marker icon */
        .volcano-marker {
            background: transparent !important;
            border: none !important;
        }
        
        /* Event item base styles */
        .event-item {
            padding: 12px 14px;
            border-bottom: 1px solid #1a1a2a;
            cursor: pointer;
            transition: background 0.15s;
        }
        .event-item:hover {
            background: #15151f;
        }
        .event-item.selected {
            background: #1a2a3a;
            border-left: 3px solid #4a8afa;
        }
        
        /* Map Popup */
        .leaflet-popup-content-wrapper {
            background: #1a1a2a;
            color: #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .leaflet-popup-tip {
            background: #1a1a2a;
        }
        .leaflet-popup-content {
            margin: 12px;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .popup-mag {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .popup-location {
            font-size: 0.9rem;
            color: #fff;
            margin-bottom: 8px;
        }
        .popup-details {
            color: #999;
            font-size: 0.75rem;
        }
        .popup-details div {
            margin: 3px 0;
        }
        .popup-link {
            display: inline-block;
            margin-top: 8px;
            color: #6af;
            text-decoration: none;
            font-size: 0.75rem;
        }
        .popup-link:hover {
            text-decoration: underline;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2a;
        }
        ::-webkit-scrollbar-thumb {
            background: #3a3a4a;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a5a;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 280px;
            }
            .header-stats {
                display: none;
            }
        }
        @media (max-width: 600px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Earthquake & <span>Volcano</span> Monitor</h1>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalCount">--</span>
                <span class="stat-label">earthquakes</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="largestMag">--</span>
                <span class="stat-label">largest</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="lastHourCount">--</span>
                <span class="stat-label">last hour</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="volcanoCount">--</span>
                <span class="stat-label">volcanoes</span>
            </div>
        </div>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label>Time:</label>
            <select id="timeRange">
                <option value="hour">Past Hour</option>
                <option value="day" selected>Past 24 Hours</option>
                <option value="week">Past 7 Days</option>
                <option value="month">Past 30 Days</option>
            </select>
        </div>
        <div class="control-group">
            <label>Magnitude:</label>
            <select id="magFilter">
                <option value="all">All</option>
                <option value="1">1.0+</option>
                <option value="2.5">2.5+</option>
                <option value="4.5">4.5+</option>
                <option value="significant">Significant</option>
            </select>
        </div>
        <div class="control-group">
            <label>Region:</label>
            <select id="regionFilter">
                <option value="world">Worldwide</option>
                <option value="us">United States</option>
                <option value="europe">Europe</option>
                <option value="asia">Asia-Pacific</option>
            </select>
        </div>
        <div class="control-group toggle-group">
            <label class="toggle-label">
                <input type="checkbox" id="showEarthquakes" checked>
                <span class="toggle-indicator quake-toggle"></span>
                Earthquakes
            </label>
            <label class="toggle-label">
                <input type="checkbox" id="showVolcanoes" checked>
                <span class="toggle-indicator volcano-toggle"></span>
                Volcanoes
            </label>
        </div>
        <div class="refresh-btn">
            <span class="last-updated" id="lastUpdated">--</span>
            <button id="refreshBtn">Refresh</button>
        </div>
    </div>
    
    <div class="main-container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="sidebar-header">Recent Activity</div>
            <div class="quake-list" id="eventList">
                <div style="padding: 20px; text-align: center; color: #555;">Loading...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== Config =====
        const USGS_BASE = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary';
        const FEEDS = {
            hour: { all: 'all_hour.geojson', '1': '1.0_hour.geojson', '2.5': '2.5_hour.geojson', '4.5': '4.5_hour.geojson', significant: 'significant_hour.geojson' },
            day: { all: 'all_day.geojson', '1': '1.0_day.geojson', '2.5': '2.5_day.geojson', '4.5': '4.5_day.geojson', significant: 'significant_day.geojson' },
            week: { all: 'all_week.geojson', '1': '1.0_week.geojson', '2.5': '2.5_week.geojson', '4.5': '4.5_week.geojson', significant: 'significant_week.geojson' },
            month: { all: 'all_month.geojson', '1': '1.0_month.geojson', '2.5': '2.5_month.geojson', '4.5': '4.5_month.geojson', significant: 'significant_month.geojson' }
        };
        
        const REGIONS = {
            world: { center: [20, 0], zoom: 2 },
            us: { center: [39, -98], zoom: 4 },
            europe: { center: [50, 10], zoom: 4 },
            asia: { center: [35, 120], zoom: 3 }
        };
        
        // Volcano API - recent volcanic eruptions/events from 2020+
        const VOLCANO_API = 'https://www.ngdc.noaa.gov/hazel/hazard-service/api/v1/volcanoes?minYear=2020';
        
        // Volcano color by recency (based on year)
        function getVolcanoColor(year) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            if (age <= 0) return '#f55';      // Current year - red
            if (age <= 1) return '#f93';      // Last year - orange
            if (age <= 2) return '#eb2';      // 2 years ago - yellow
            if (age <= 3) return '#9b5';      // 3 years ago - yellow-green
            return '#6a9';                     // Older - teal
        }
        
        function getVolcanoStatus(year) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            if (age <= 0) return 'Recent Activity';
            if (age <= 1) return 'Active Last Year';
            if (age <= 2) return 'Active ' + year;
            return 'Eruption ' + year;
        }
        
        // ===== State =====
        let earthquakes = [];
        let volcanoes = [];
        let quakeMarkers = [];
        let volcanoMarkers = [];
        let selectedEventId = null;
        let showEarthquakes = true;
        let showVolcanoes = true;
        
        // ===== Map Setup =====
        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            zoomControl: true,
            attributionControl: false
        });
        
        // Dark map tiles (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // Attribution (required but styled minimal)
        L.control.attribution({
            position: 'bottomright',
            prefix: false
        }).addTo(map).addAttribution('<a href="https://earthquake.usgs.gov/" style="color:#555">USGS</a> | <a href="https://carto.com/" style="color:#555">CartoDB</a>');
        
        // ===== Functions =====
        function getMagColor(mag) {
            if (mag >= 8) return '#f2f';
            if (mag >= 7) return '#f52';
            if (mag >= 6) return '#f82';
            if (mag >= 5) return '#eb2';
            if (mag >= 4) return '#bc3';
            if (mag >= 3) return '#8c4';
            if (mag >= 2) return '#6b4';
            return '#4a9';
        }
        
        function getMagClass(mag) {
            return 'mag-' + Math.min(9, Math.floor(mag));
        }
        
        function getMarkerSize(mag) {
            return Math.max(6, Math.min(40, mag * 5));
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return Math.floor(diff / 86400000) + 'd ago';
        }
        
        function formatFullTime(timestamp) {
            return new Date(timestamp).toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
        }
        
        function clearQuakeMarkers() {
            quakeMarkers.forEach(m => map.removeLayer(m));
            quakeMarkers = [];
        }
        
        function clearVolcanoMarkers() {
            volcanoMarkers.forEach(m => map.removeLayer(m));
            volcanoMarkers = [];
        }
        
        function clearAllMarkers() {
            clearQuakeMarkers();
            clearVolcanoMarkers();
        }
        
        function createQuakeMarker(quake) {
            const coords = quake.geometry.coordinates;
            const props = quake.properties;
            const mag = props.mag || 0;
            const size = getMarkerSize(mag);
            const color = getMagColor(mag);
            
            const marker = L.circleMarker([coords[1], coords[0]], {
                radius: size / 2,
                fillColor: color,
                color: color,
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.4
            });
            
            const popupContent = `
                <div class="popup-mag ${getMagClass(mag)}">${mag.toFixed(1)}</div>
                <div class="popup-location">${props.place || 'Unknown location'}</div>
                <div class="popup-details">
                    <div><strong>Time:</strong> ${formatFullTime(props.time)}</div>
                    <div><strong>Depth:</strong> ${coords[2].toFixed(1)} km</div>
                    <div><strong>Status:</strong> ${props.status}</div>
                    ${props.tsunami ? '<div style="color:#f82"><strong>Tsunami Warning</strong></div>' : ''}
                </div>
                <a class="popup-link" href="${props.url}" target="_blank">View on USGS →</a>
            `;
            
            marker.bindPopup(popupContent);
            marker.eventId = quake.id;
            marker.eventType = 'earthquake';
            
            marker.on('click', () => {
                selectEvent(quake.id);
            });
            
            return marker;
        }
        
        function createVolcanoMarker(volcano) {
            const lat = volcano.latitude;
            const lng = volcano.longitude;
            const year = volcano.year || 2020;
            const color = getVolcanoColor(year);
            const status = getVolcanoStatus(year);
            
            // Create triangle marker using SVG
            const triangleIcon = L.divIcon({
                className: 'volcano-marker',
                html: `<svg width="20" height="20" viewBox="0 0 20 20">
                    <polygon points="10,2 18,18 2,18" fill="${color}" stroke="#000" stroke-width="1" opacity="0.85"/>
                </svg>`,
                iconSize: [20, 20],
                iconAnchor: [10, 18],
                popupAnchor: [0, -15]
            });
            
            const marker = L.marker([lat, lng], { icon: triangleIcon });
            
            const elevation = volcano.elevation ? `${volcano.elevation} m` : 'Unknown';
            const vei = volcano.vei ? `VEI ${volcano.vei}` : '';
            const deaths = volcano.deaths ? `${volcano.deaths} deaths` : '';
            
            const popupContent = `
                <div class="popup-mag" style="color: ${color}">▲</div>
                <div class="popup-location">${volcano.name || 'Unknown Volcano'}</div>
                <div class="popup-details">
                    <div><strong>Location:</strong> ${volcano.location || volcano.country || 'Unknown'}</div>
                    <div><strong>Type:</strong> ${volcano.morphology || 'Unknown'}</div>
                    <div><strong>Elevation:</strong> ${elevation}</div>
                    <div><strong>Event Date:</strong> ${volcano.year}${volcano.month ? '/' + volcano.month : ''}${volcano.day ? '/' + volcano.day : ''}</div>
                    ${vei ? `<div><strong>Intensity:</strong> ${vei}</div>` : ''}
                    ${deaths ? `<div style="color:#f55"><strong>Casualties:</strong> ${deaths}</div>` : ''}
                    <div><strong>Status:</strong> <span style="color: ${color}">${status}</span></div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            marker.eventId = 'volcano-' + volcano.id;
            marker.eventType = 'volcano';
            
            marker.on('click', () => {
                selectEvent(marker.eventId);
            });
            
            return marker;
        }
        
        function selectEvent(id) {
            selectedEventId = id;
            
            // Update list selection
            document.querySelectorAll('.event-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === id);
            });
            
            // Scroll to item
            const selectedEl = document.querySelector(`.event-item[data-id="${id}"]`);
            if (selectedEl) {
                selectedEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function renderEventList() {
            const container = document.getElementById('eventList');
            
            // Build combined list
            let items = [];
            
            // Add earthquakes if shown
            if (showEarthquakes) {
                earthquakes.forEach(quake => {
                    const props = quake.properties;
                    items.push({
                        type: 'earthquake',
                        id: quake.id,
                        time: props.time,
                        data: quake
                    });
                });
            }
            
            // Add volcanoes if shown (use actual event date for sorting)
            if (showVolcanoes) {
                volcanoes.forEach(volcano => {
                    const volcanoTime = new Date(
                        volcano.year || 2020,
                        (volcano.month || 1) - 1,
                        volcano.day || 1
                    ).getTime();
                    items.push({
                        type: 'volcano',
                        id: 'volcano-' + volcano.id,
                        time: volcanoTime,
                        data: volcano
                    });
                });
            }
            
            // Sort by time (earthquakes will be more recent)
            items.sort((a, b) => b.time - a.time);
            
            if (items.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #555;">No events found</div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                if (item.type === 'earthquake') {
                    const quake = item.data;
                    const props = quake.properties;
                    const coords = quake.geometry.coordinates;
                    const mag = props.mag || 0;
                    
                    return `
                        <div class="event-item quake-item" data-id="${quake.id}" data-type="earthquake">
                            <div class="quake-header">
                                <div class="quake-mag ${getMagClass(mag)}">${mag.toFixed(1)}</div>
                                <div class="quake-location">${props.place || 'Unknown'}</div>
                            </div>
                            <div class="quake-details">
                                <span>${formatTime(props.time)}</span>
                                <span>${coords[2].toFixed(1)} km deep</span>
                                ${props.tsunami ? '<span style="color:#f82">⚠ Tsunami</span>' : ''}
                            </div>
                        </div>
                    `;
                } else {
                    const volcano = item.data;
                    const year = volcano.year || 2020;
                    const color = getVolcanoColor(year);
                    const status = getVolcanoStatus(year);
                    const vei = volcano.vei ? `VEI ${volcano.vei}` : '';
                    
                    return `
                        <div class="event-item volcano-item" data-id="volcano-${volcano.id}" data-type="volcano" style="border-left: 3px solid ${color}">
                            <div class="quake-header">
                                <div class="quake-mag" style="color: ${color}; font-size: 1.2rem;">▲</div>
                                <div class="quake-location">${volcano.name || 'Unknown Volcano'}</div>
                            </div>
                            <div class="quake-details">
                                <span>${volcano.country || 'Unknown'}</span>
                                <span>${volcano.year}${volcano.month ? '/' + volcano.month : ''}</span>
                                ${vei ? `<span>${vei}</span>` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.event-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.dataset.id;
                    const type = el.dataset.type;
                    
                    if (type === 'earthquake') {
                        const quake = earthquakes.find(q => q.id === id);
                        if (quake) {
                            const coords = quake.geometry.coordinates;
                            map.setView([coords[1], coords[0]], 8);
                            const marker = quakeMarkers.find(m => m.eventId === id);
                            if (marker) marker.openPopup();
                        }
                    } else {
                        const volcanoId = id.replace('volcano-', '');
                        const volcano = volcanoes.find(v => v.id == volcanoId);
                        if (volcano) {
                            map.setView([volcano.latitude, volcano.longitude], 8);
                            const marker = volcanoMarkers.find(m => m.eventId === id);
                            if (marker) marker.openPopup();
                        }
                    }
                    
                    selectEvent(id);
                });
            });
        }
        
        function updateStats() {
            const now = Date.now();
            const lastHour = earthquakes.filter(q => now - q.properties.time < 3600000);
            const mags = earthquakes.map(q => q.properties.mag || 0);
            const maxMag = mags.length > 0 ? Math.max(...mags) : 0;
            
            document.getElementById('totalCount').textContent = earthquakes.length;
            document.getElementById('largestMag').textContent = maxMag.toFixed(1);
            document.getElementById('lastHourCount').textContent = lastHour.length;
            document.getElementById('volcanoCount').textContent = volcanoes.length;
        }
        
        async function loadVolcanoes() {
            try {
                const response = await fetch(VOLCANO_API);
                const data = await response.json();
                
                // Get items and sort by year (most recent first)
                volcanoes = data.items || data;
                volcanoes = volcanoes.sort((a, b) => {
                    // Sort by year, then month, then day
                    if (b.year !== a.year) return b.year - a.year;
                    if ((b.month || 0) !== (a.month || 0)) return (b.month || 0) - (a.month || 0);
                    return (b.day || 0) - (a.day || 0);
                });
                
                // Clear and add volcano markers if shown
                clearVolcanoMarkers();
                if (showVolcanoes) {
                    volcanoes.forEach(volcano => {
                        if (volcano.latitude && volcano.longitude) {
                            const marker = createVolcanoMarker(volcano);
                            marker.addTo(map);
                            volcanoMarkers.push(marker);
                        }
                    });
                }
                
            } catch (err) {
                console.error('Volcano load error:', err);
                volcanoes = [];
            }
        }
        
        async function loadEarthquakes() {
            const timeRange = document.getElementById('timeRange').value;
            const magFilter = document.getElementById('magFilter').value;
            const region = document.getElementById('regionFilter').value;
            
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            refreshBtn.textContent = 'Loading...';
            
            try {
                const feed = FEEDS[timeRange][magFilter] || FEEDS[timeRange]['all'];
                const url = `${USGS_BASE}/${feed}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                earthquakes = data.features.sort((a, b) => b.properties.time - a.properties.time);
                
                // Clear and add earthquake markers if shown
                clearQuakeMarkers();
                if (showEarthquakes) {
                    earthquakes.forEach(quake => {
                        const marker = createQuakeMarker(quake);
                        marker.addTo(map);
                        quakeMarkers.push(marker);
                    });
                }
                
                // Update view if region changed
                const regionConfig = REGIONS[region];
                if (regionConfig) {
                    map.setView(regionConfig.center, regionConfig.zoom);
                }
                
            } catch (err) {
                console.error('Earthquake load error:', err);
                document.getElementById('eventList').innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: #f55;">Failed to load earthquake data</div>';
            }
            
            refreshBtn.classList.remove('loading');
            refreshBtn.textContent = 'Refresh';
        }
        
        async function loadAllData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            refreshBtn.textContent = 'Loading...';
            
            await Promise.all([loadEarthquakes(), loadVolcanoes()]);
            
            renderEventList();
            updateStats();
            
            document.getElementById('lastUpdated').textContent = 
                'Updated ' + new Date().toLocaleTimeString();
            
            refreshBtn.classList.remove('loading');
            refreshBtn.textContent = 'Refresh';
        }
        
        function toggleEarthquakes() {
            showEarthquakes = document.getElementById('showEarthquakes').checked;
            
            if (showEarthquakes) {
                earthquakes.forEach(quake => {
                    const marker = createQuakeMarker(quake);
                    marker.addTo(map);
                    quakeMarkers.push(marker);
                });
            } else {
                clearQuakeMarkers();
            }
            
            renderEventList();
        }
        
        function toggleVolcanoes() {
            showVolcanoes = document.getElementById('showVolcanoes').checked;
            
            if (showVolcanoes) {
                volcanoes.forEach(volcano => {
                    if (volcano.latitude && volcano.longitude) {
                        const marker = createVolcanoMarker(volcano);
                        marker.addTo(map);
                        volcanoMarkers.push(marker);
                    }
                });
            } else {
                clearVolcanoMarkers();
            }
            
            renderEventList();
        }
        
        // ===== Event Listeners =====
        document.getElementById('timeRange').addEventListener('change', loadAllData);
        document.getElementById('magFilter').addEventListener('change', loadAllData);
        document.getElementById('regionFilter').addEventListener('change', () => {
            const region = document.getElementById('regionFilter').value;
            const config = REGIONS[region];
            if (config) {
                map.setView(config.center, config.zoom);
            }
            loadAllData();
        });
        document.getElementById('refreshBtn').addEventListener('click', loadAllData);
        document.getElementById('showEarthquakes').addEventListener('change', toggleEarthquakes);
        document.getElementById('showVolcanoes').addEventListener('change', toggleVolcanoes);
        
        // ===== Init =====
        loadAllData();
        
        // Auto refresh every 5 minutes
        setInterval(loadAllData, 5 * 60 * 1000);
    </script>
</body>
</html>
